# redis持久化对于灾难恢复的意义

redis有一个持久化的功能，在很多的视频和资料中都有对持久化的介绍，那么持久化对于什么样场景有着重大的意义呢？

## 故障发生的时候会怎么样

在实际的情况中有着这样的情况，redis突然挂掉了，进程死了，或者所在的机器没了，遇到了灾难性的故障，因为redis的数据存在内存中

这时候内存中的数据就都没有了，很重要的缓存数据等等，redis会重启，重启之后要费很大的劲去恢复，如果单单把数据放到内存中，

是没有任何办法应对一些灾难性的故障的，所以redis中的持久化是很重要的。再通过定期备份数据，是可以恢复一部分数据的。
 
**意义**

在企业级的redis集群架构中，持久化的主要意义就是做灾难恢复，数据恢复，
 
 
## redis中RDB和AOF两种持久化的介绍
 
RDB持久化机制，对redis中的数据执行周期性的持久化存储，而且是完整的数据存储。 意思是假如每隔一个小时就存储一份现在redis内存中的全部数据。
 
![图解](https://user-images.githubusercontent.com/34649300/55392671-59a10880-556e-11e9-80bd-e3c64ede497f.png)

AOF机制对每条写入命令作为日志，以append-only的模式写入一个日志文件中，在redis重启的时候，可以通过回放AOF日志中的写入指令来重新构建整个数据集

AOF的机制只对一个AOF日志文件做写入（仅追加 append-only）操作，在liunx系统中，中间会经过os cache然后才会写入磁盘中，AOF文件存放的是redis的写入指令。

假如内存中的数据最多存放1G，那么AOF文件的大小也将会被控制在1G范围之内，当内存中的数据超过1G的时候，AOF会利用一种缓存淘汰算法（LRU）
将最不常用的数据清除,而AOF的rewrite操作会基于redis清除后的内存中的数据重新构造一个更小的AOF文件，然后将旧的文件删除。

如果redis挂了，服务器上的内存和磁盘上的数据都丢了，可以从云服务上拷贝回来之前的数据，放到指定的目录中，然后重新启动redis，redis就会自动根据持久化数据文件中的数据，去恢复内存中的数据，继续对外提供服务
如果同时使用RDB和AOF两种持久化机制，那么在redis重启的时候，会使用AOF来重新构建数据，因为AOF中的数据更加完整。

![RDB和AOF的介绍](https://user-images.githubusercontent.com/34649300/55464789-73098980-562e-11e9-8441-626fab559aae.png)

## RDB持久化机制的优点

- RDB会生成多个数据文件，每个数据文件都代表了某一个时刻中redis的数据，这种多个数据文件的方式，非常适合做冷备，可以将这种完整的数据文件发送到一些远程的安全存储上去，比如说Amazon的S3云服务上去，
  在国内可以是阿里云的ODPS分布式存储上，以预定好的备份策略来定期备份redis中的数据
  
- RDB对redis对外提供的读写服务，影响非常小，可以让redis保持高性能，因为redis主进程只需要fork一个子进程，让子进程执行磁盘IO操作来进行RDB持久化即可

- 相对于AOF持久化机制来说，直接基于RDB数据文件来重启和恢复redis进程，更加快速

## RDB持久化机制的缺点

- 如果想要在redis故障时，尽可能少的丢失数据，那么RDB没有AOF好。一般来说，RDB数据快照文件，都是每隔5分钟，或者更长时间生成一次，这个时候就得接受一旦redis进程宕机，那么会丢失最近5分钟的数据

- RDB每次在fork子进程来执行RDB快照数据文件生成的时候，如果数据文件特别大，可能会导致对客户端提供的服务暂停数毫秒，或者甚至数秒，所以一般不要间隔太长时间进行持久化操作。

## AOF持久化机制的优点

- AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次fsync操作，最多丢失1秒钟的数据

- AOF日志文件以append-only模式写入，所以没有任何磁盘寻址的开销，写入性能非常高，而且文件不容易破损，即使文件尾部破损，也很容易修复

- AOF日志文件即使过大的时候，出现后台重写操作，也不会影响客户端的读写。因为在rewrite log的时候，会对其中的指导进行压缩，创建出一份需要恢复数据的最小日志出来。再创建新日志文件的时候，老的日志文件还是照常写入。
  当新的merge后的日志文件ready的时候，再交换新老日志文件即可。

- AOF日志文件的命令通过非常可读的方式进行记录，这个特性非常适合做灾难性的误删除的紧急恢复。比如某人不小心用flushall命令清空了所有数据，只要这个时候后台rewrite还没有发生，那么就可以立即拷贝AOF文件，
  将最后一条flushall命令给删了，然后再将该AOF文件放回去，就可以通过恢复机制，自动恢复所有数据

## AOF持久化机制的缺点

- 对于同一份数据来说，AOF日志文件通常比RDB数据快照文件更大

- AOF开启后，支持的写QPS会比RDB支持的写QPS低，因为AOF一般会配置成每秒fsync一次日志文件，当然，每秒一次fsync，性能也还是很高的

- 以前AOF发生过bug，就是通过AOF记录的日志，进行数据恢复的时候，没有恢复一模一样的数据出来。所以说，类似AOF这种较为复杂的基于命令日志/merge/回放的方式，比基于RDB每次持久化一份完整的数据快照文件的方式，更加脆弱一些，容易有bug。
  不过AOF就是为了避免rewrite过程导致的bug，因此每次rewrite并不是基于旧的指令日志进行merge的，而是基于当时内存中的数据进行指令的重新构建，这样健壮性会好很多。


## RDB和AOF到底该如何选择

- 不要仅仅使用RDB，因为那样会导致你丢失很多数据

- 也不要仅仅使用AOF，因为那样有两个问题，第一，你通过AOF做冷备，没有RDB做冷备，来的恢复速度更快; 第二，RDB每次简单粗暴生成数据快照，更加健壮，可以避免AOF这种复杂的备份和恢复机制的bug

- 综合使用AOF和RDB两种持久化机制，用AOF来保证数据不丢失，作为数据恢复的第一选择; 用RDB来做不同程度的冷备，在AOF文件都丢失或损坏不可用的时候，还可以使用RDB来进行快速的数据恢复


## 总结

总体来说redis在我们的项目中作为缓存是非常重要的，为我们的mysql等数据库分担了很多的压力，而缓存中的数据又是重中之重，所以redis中的持久化对我们来讲就是必须要会的一点知识

这章节讲述了以下几点

- 持久化的意义？

- 对于出现灾难性的意外如何应对？
> 采用持久化和周期性备份来应对灾难性的出现

- 两种持久化的优劣对比

